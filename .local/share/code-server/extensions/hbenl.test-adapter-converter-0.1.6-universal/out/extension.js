var P=Object.create;var f=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var L=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),W=(r,e)=>{for(var t in e)f(r,t,{get:e[t],enumerable:!0})},R=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of U(e))!F.call(r,o)&&o!==t&&f(r,o,{get:()=>e[o],enumerable:!(s=D(e,o))||s.enumerable});return r};var h=(r,e,t)=>(t=r!=null?P(H(r)):{},R(e||!r||!r.__esModule?f(t,"default",{value:r,enumerable:!0}):t,r)),j=r=>R(f({},"__esModule",{value:!0}),r);var E=L(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.testExplorerExtensionId=void 0;T.testExplorerExtensionId="hbenl.vscode-test-explorer"});var V={};W(V,{activate:()=>G});module.exports=j(V);var p=h(require("vscode")),C=h(E());var u=h(require("vscode")),k="promptedToUseNative",S=!1,m="testExplorer.useNativeTesting",b=()=>!!u.workspace.getConfiguration().get(m,!1),v=(r=u.ConfigurationTarget.Global)=>{u.workspace.getConfiguration().update(m,!0,r),u.window.showInformationMessage('Thanks for taking native testing for a spin! If you run into problems, you can turn the new experience off with the "testExplorer.useNativeTesting" setting.')};var g=class{constructor(e){this.context=e}registerTestAdapter(e){!this.shouldPrompt()||e.testStates(t=>{t.type==="started"&&this.promptToUseNativeTesting()})}unregisterTestAdapter(){}shouldPrompt(){return!S&&!b()&&!this.context.globalState.get(k)}async promptToUseNativeTesting(){if(!this.shouldPrompt())return;let e="Yes",t="Only in this Workspace",s="No";S=!0;let o=await u.window.showInformationMessage("Would you like to try out VS Code's new native UI for testing?",s,e,t);!o||(o===e?v(u.ConfigurationTarget.Global):o===t?v(u.ConfigurationTarget.Workspace):o===s&&this.context.globalState.update(k,!0))}};var N=h(require("vscode"));var i=h(require("vscode")),B=new WeakMap,K=(r,e)=>{let t=new Set;return r.filter(s=>{let o=e(s);return t.has(o)?!1:(t.add(o),!0)})},O="workbench.view.extension.test",$=1,I=class{constructor(e){this.adapter=e;this.itemsById=new Map;this.tasksByRunId=new Map;this.runningSuiteByRunId=new Map;this.disposables=[];this.controller=i.tests.createTestController(`test-adapter-ctrl-${$++}`,""),this.controller.refreshHandler=()=>this.adapter.load(),this.disposables.push(this.controller);let t=s=>(o,n)=>{if(!o.include){this.run(this.controller.createTestRun(o),o.include,s,n);return}let a=new Map;for(let d of o.include){let l=B.get(d).converter,c=a.get(l);c?c.push(d):a.set(l,[d])}for(let[d,l]of a)d.run(this.controller.createTestRun(o),l,s,n)};this.controller.createRunProfile("Run",i.TestRunProfileKind.Run,t(!1),!0),this.controller.createRunProfile("Debug",i.TestRunProfileKind.Debug,t(!0),!0),this.disposables.push(e.tests(s=>{var o;switch(s.type){case"finished":(o=this.doneDiscovery)==null||o.call(this),this.doneDiscovery=void 0,this.itemsById.clear(),this.syncTopLevel(s);break;case"started":this.doneDiscovery||i.window.withProgress({location:{viewId:O}},()=>new Promise(n=>{this.doneDiscovery=n}));break}}),e.testStates(s=>{var n,a;let o=this.tasksByRunId.get((n=s.testRunId)!=null?n:"");if(!!o)switch(s.type){case"test":return this.onTestEvent(o,s);case"suite":return this.onTestSuiteEvent(s);case"finished":return this.tasksByRunId.delete((a=s.testRunId)!=null?a:""),o.end()}}))}get controllerId(){return this.controller.id}dispose(){this.disposables.forEach(e=>e.dispose())}async run(e,t,s,o){if(!this.controller)return;t||(t=M(this.controller.items));let n=this.adapter.testStates(a=>{var l;if(a.type!=="started")return;let d=[t];for(;d.length;)for(let c of d.pop())e.enqueued(c),d.push(M(c.children));this.tasksByRunId.set((l=a.testRunId)!=null?l:"",e),o.onCancellationRequested(()=>this.adapter.cancel()),n.dispose()});s?this.adapter.debug?this.adapter.debug(t.map(a=>a.id)):n.dispose():this.adapter.run(t.map(a=>a.id))}syncTopLevel(e){if(i.commands.executeCommand("setContext","hasTestConverterTests",!0),e.suite)this.controller.label=this.adapter.workspaceFolder?`${this.adapter.workspaceFolder.name} - ${e.suite.label}`:e.suite.label,this.syncItemChildren(this.controller.items,e.suite.children);else if(e.errorMessage){let t=this.controller.createTestItem("error","Test discovery failed");t.error=e.errorMessage,this.controller.items.replace([t])}}syncItemChildren(e,t,s){e.replace(K(t,o=>o.id).map(o=>this.createTest(o,s)))}createTest(e,t){let s=this.controller.createTestItem(e.id,e.label,e.file?A(e.file):t);return B.set(s,{converter:this}),this.itemsById.set(e.id,s),s.description=e.description,e.line!==void 0&&(s.range=new i.Range(e.line,0,e.line+1,0)),e.errored&&(s.error=e.message),"children"in e&&this.syncItemChildren(s.children,e.children),s}onTestSuiteEvent(e){var n;let t=(n=e.testRunId)!=null?n:"",s=this.runningSuiteByRunId.get(t),o=typeof e.suite=="string"?e.suite:e.suite.id;e.state==="running"?(!this.itemsById.has(o)&&typeof e.suite=="object"&&s&&s.children.add(this.createTest(e.suite)),this.itemsById.has(o)&&this.runningSuiteByRunId.set(t,this.itemsById.get(o))):s&&s.id===o&&(s.parent?this.runningSuiteByRunId.set(t,s.parent):this.runningSuiteByRunId.delete(t))}onTestEvent(e,t){var a,d;let s=this.runningSuiteByRunId.get((a=t.testRunId)!=null?a:""),o=typeof t.test=="string"?t.test:t.test.id;t.state==="running"&&!this.itemsById.has(o)&&typeof t.test=="object"&&s&&s.children.add(this.createTest(t.test));let n=this.itemsById.get(o);if(!!n){switch(t.state){case"skipped":e.skipped(n);break;case"running":e.started(n);break;case"passed":e.passed(n);break;case"errored":case"failed":let l=[];if(t.message){let c=new i.TestMessage(t.message);l.push(c)}for(let c of(d=t.decorations)!=null?d:[]){let w=new i.TestMessage(c.message),x=c.file?A(c.file):n.uri;x&&(w.location=new i.Location(x,new i.Position(c.line,0))),l.push(w)}e[t.state](n,l);break}t.message&&(t.state!=="errored"&&t.state!=="failed"||!n.uri)&&e.appendOutput(t.message.replace(/\r?\n/g,`\r
`))}}},M=r=>{let e=[];return r.forEach(t=>e.push(t)),e},z=/^[a-z][a-z0-9+-.]+:/,A=r=>z.test(r)?i.Uri.parse(r):i.Uri.file(r);var y=class{constructor(){this.converters=new Map}registerTestAdapter(e){this.converters.set(e,new I(e))}unregisterTestAdapter(e){var t;(t=this.converters.get(e))==null||t.dispose(),this.converters.delete(e)}dispose(){for(let e of this.converters.values())e.dispose();N.commands.executeCommand("setContext","hasTestConverterTests",!1)}};function G(r){let e,t=new g(r);p.env.appName.toLowerCase().includes("insiders")&&t.shouldPrompt()&&setTimeout(()=>{var o;let s=(o=p.extensions.getExtension(C.testExplorerExtensionId))==null?void 0:o.exports;!s||(s.registerTestController(t),r.subscriptions.push({dispose(){s.unregisterTestController(t)}}))},2e3),r.subscriptions.push(p.commands.registerCommand("testExplorerConverter.activate",()=>{var o;let s=(o=p.extensions.getExtension(C.testExplorerExtensionId))==null?void 0:o.exports;!s||(e=new y,r.subscriptions.push(e),s.registerTestController(e),r.subscriptions.push({dispose(){s.unregisterTestController(e)}}))}),p.workspace.onDidChangeConfiguration(s=>{!s.affectsConfiguration(m)||b()||(e==null||e.dispose(),e=void 0)}),p.commands.registerCommand("testExplorerConverter.useNativeTesting",()=>v()))}0&&(module.exports={activate});
